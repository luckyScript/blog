<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        *{
            padding: 0;
            margin: 0;
        }
        canvas{
            background: url("bk.png") no-repeat;
            background-position: 50%;
        }
    </style>
</head>
<body>

<div><canvas id="canvas" width="1000"  height="600"></canvas></div>

<script>
    var textPixel = function(){
        var RAF = (function() {
            return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
                        return window.setTimeout(callback, 1000/60);
                    };
        })();
        function getRandom (a , b){
            var num;
            num = Math.random()*( a - b ) + b;
            num = num + 0.5 | 0;
            return ~~num;
        }
        Array.prototype.forEach = function(callback){
            for(var i = 0 ; i< this.length; i++){
                callback.call(this[i]);
            }
        }
        var focallength = 100; //焦距
        var init = function(getTextValue){
            this.canvas = document.getElementById('canvas'),
                    this.ctx= canvas.getContext("2d");
            this.canvas.width = window.innerWidth;
            this.canvas.height = 600;
            this.initialize(getTextValue);
        };
        init.prototype = {
            initialize:function(getTextValue){
                this.textDataArr = getTextValue;
                this.textDataArrIndex = 0;
                this.particleActive = 0 ;
                this.particles = [];
                this.fillText();
                this.getTextData();
                this.initDraw();
            },
            fillText:function(){
                var text = this.textDataArr[this.textDataArrIndex];
                if(text!=="" && text ){
                    this.ctx.font = "180px 微软雅黑 bold";
                    this.ctx.fillStyle = "reba(180,180,180,1)";
                    this.ctx.textAlign = "center";
                    this.ctx.textBaseline = "middle";
                    this.ctx.fillText(text ,this.canvas.width / 2 , this.canvas.height /2);
                }
            },
            getTextData:function(){
                var textData = this.ctx.getImageData( 0 ,0 ,this.canvas.width , this.canvas.height );
                this.ctx.clearRect(0 , 0 ,this.canvas.width , this.canvas.height);
                this.particles = [];
                for(var x  = 0; x < textData.width;x+=6){
                    for(var y = 0; y < textData.height; y+=6){
                        var i = 4*( y*textData.width + x);
                        if(textData.data[i+3] > 126){
                            var aPixel = new Particle( x+3 , y+3 ,this.canvas,this.ctx ,3);
                            this.particles.push(aPixel);
                        }
                    }
                }
            },
            initDraw:function(){
                this.particles.forEach(function(){
                    this.mx = ~~ ( Math.random() * this.canvas.width );
                    this.my = ~~ ( Math.random() * this.canvas.width );
                    this.mz = Math.random() * focallength * 2 - focallength ;
                    this.newx = ~~ ( Math.random() * this.canvas.width );
                    this.newy = ~~ ( Math.random() * this.canvas.width );
                    this.newz = Math.random() * focallength * 2 - focallength;
                    this.paint();
                })
            },
            annimation:function(){
                var that = this;
                this.ctx.save();
                this.ctx.globalAlpha =0.1;
//                this.ctx.fillStyle = "#000"
                this.ctx.globalCompositeOperation="destination-out";
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.restore();
                this.particles.forEach(function () {
                    if(that.particleActive == 0) {
                        if (Math.abs(this.endx - this.mx) < 0.1 && Math.abs(this.endy - this.my) < 0.1 && Math.abs(this.endz - this.mz) < 0.1) {
                            this.mx = this.endx;
                            this.my = this.endy;
                            this.mz = this.endz;
                            setTimeout(function(){
                                that.particleActive = 1;
                            },1000)
                        } else {
                            this.mx = this.mx + (this.endx - this.mx) * 0.08;
                            this.my = this.my + (this.endy - this.my) * 0.08;
                            this.mz = this.mz + (this.endz - this.mz) * 0.08;
                        }
                    }else if( that.particleActive == 1 ){
                        if (Math.abs(this.newx - this.mx) < 0.1 && Math.abs(this.newy - this.my) < 0.1 && Math.abs(this.newz - this.mz) < 0.1) {
                            this.mx = this.newx;
                            this.my = this.newy;
                            this.mz = this.newz;
                            that.particleActive = 2;
                        } else {
                            this.mx = this.mx + (this.newx - this.mx) * 0.08;
                            this.my = this.my + (this.newy - this.my) * 0.08;
                            this.mz = this.mz + (this.newz - this.mz) * 0.08;
                        }
                    }
                    this.paint();
                })
            },
            start:function(){
                var that = this;
                this.annimation();
                if(this.particleActive != 2){
                    RAF(function(){
                        that.start()
                    })
                }
                else{
                    this.textDataArrIndex +=1;
                    if(this.textDataArrIndex<=2) {
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        this.particleActive = 0;
                        this.fillText();
                        this.getTextData();
                        this.initDraw()
                        this.annimation()
                        that.start()
                    }
                }
            }
        }
        var Particle = function ( x, y ,canvas ,ctx , r){
            this.canvas = canvas;
            this.color = getRandom(255,1)  +","+ getRandom(255,1) + "," + getRandom(255,1) + ","
            this.ctx = ctx;
            this.endx = x;
            this.endy = y;
            this.endz = 0;
            this.mx = 0;
            this.my = 0;
            this.newz = 0;
            this.newx =0;
            this.newy =0;
            this.newz= 0;
            this.radius = r;
        }
        Particle.prototype = {
            paint:function(){
                this.scale = focallength / (focallength + this.mz);
                this.ctx.beginPath();
                this.ctx.arc(
                        this.canvas.width / 2 + (this.mx - this.canvas.width / 2) * this.scale,
                        this.canvas.height / 2 + (this.my - this.canvas.height / 2)* this.scale,
                        this.radius * this.scale , 0  , 2* Math.PI
                )
                this.ctx.fillStyle = "rgba("+ this.color + this.scale +")";
//                this.ctx.fillStyle = "rgba(200,200,200,"+ this.scale +")";
                this.ctx.fill();
            }
        }
        return init;
    }();
    var app;
   
    (function start(){
        var getTextValue = function(){
            var textArr =["你一句明天见","偷走了我","整晚的睡眠"];
            
            return textArr;
        }();
        app = new textPixel(getTextValue);
        app.start();
    })();
</script>
</body>
</html>